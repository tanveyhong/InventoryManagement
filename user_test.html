<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management Test - Firebase Integration</title>
    <link rel="stylesheet" href="assets/css/style.css">
    <style>
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .test-result {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            color: #2e7d32;
            padding: 10px;
            border-radius: 3px;
            margin: 10px 0;
        }
        .test-error {
            background: #ffebee;
            border: 1px solid #f44336;
            color: #c62828;
            padding: 10px;
            border-radius: 3px;
            margin: 10px 0;
        }
        .button {
            background: #2196f3;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 3px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background: #1976d2;
        }
        .user-card {
            background: white;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
        }
        .status {
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 3px;
        }
        .status.online {
            background: #4caf50;
            color: white;
        }
        .status.offline {
            background: #ff9800;
            color: white;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>Firebase User Management Integration Test</h1>
        
        <div class="test-section">
            <h2>üî• Firebase Connection Status</h2>
            <div id="firebase-status" class="status offline">Connecting...</div>
            <p>This tests if Firebase is properly connected and accessible.</p>
        </div>

        <div class="test-section">
            <h2>üë• User Management Tests</h2>
            
            <div>
                <h3>Quick Links</h3>
                <a href="modules/users/register.php" class="button">Test Registration</a>
                <a href="modules/users/login.php" class="button">Test Login</a>
                <a href="modules/users/profile.php" class="button">Test Profile (Login Required)</a>
            </div>

            <div id="user-tests">
                <h3>Firebase User Operations</h3>
                <button class="button" onclick="testCreateUser()">Create Test User</button>
                <button class="button" onclick="testListUsers()">List All Users</button>
                <button class="button" onclick="testUpdateUser()">Update Test User</button>
                <button class="button" onclick="testDeleteUser()">Delete Test User</button>
                <button class="button" onclick="clearResults()">Clear Results</button>
                
                <div id="test-results"></div>
            </div>
        </div>

        <div class="test-section">
            <h2>üìù Test User Data</h2>
            <p>Use these credentials to test the user modules:</p>
            <div class="user-card">
                <strong>Test User 1:</strong><br>
                Username: testuser1<br>
                Email: test1@example.com<br>
                Password: testpass123<br>
                Name: John Doe
            </div>
            <div class="user-card">
                <strong>Test User 2:</strong><br>
                Username: testuser2<br>
                Email: test2@example.com<br>
                Password: testpass456<br>
                Name: Jane Smith
            </div>
        </div>

        <div class="test-section">
            <h2>üõ†Ô∏è Migration Status</h2>
            <div class="test-result">
                ‚úÖ Firebase SDK installed and configured<br>
                ‚úÖ Database class updated to use Firestore<br>
                ‚úÖ User registration migrated to Firebase<br>
                ‚úÖ User login migrated to Firebase<br>
                ‚úÖ User profile management migrated to Firebase<br>
                ‚úÖ User logout functionality updated<br>
                ‚úÖ Helper functions created for Firebase operations
            </div>
        </div>

        <div class="test-section">
            <h2>üìö Documentation</h2>
            <p>
                <a href="FIREBASE_MIGRATION.md" class="button">View Migration Guide</a>
                <a href="firebase_test.html" class="button">Basic Firebase Test</a>
            </p>
            <p>The Firebase integration includes:</p>
            <ul>
                <li>Firestore for user data storage</li>
                <li>Offline support with automatic sync</li>
                <li>Real-time updates capability</li>
                <li>Enhanced security with Firebase rules</li>
                <li>Backward compatibility with existing session management</li>
            </ul>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- Firebase configuration -->
    <script src="assets/js/firebase.js"></script>
    
    <script>
        let testUserId = null;
        
        // Initialize Firebase status
        document.addEventListener('DOMContentLoaded', function() {
            checkFirebaseConnection();
        });
        
        async function checkFirebaseConnection() {
            const statusDiv = document.getElementById('firebase-status');
            
            try {
                // Test Firestore connection
                const testCollection = firebaseDb.collection('_test_connection');
                await testCollection.add({
                    test: true,
                    timestamp: new Date()
                });
                
                statusDiv.className = 'status online';
                statusDiv.textContent = 'Connected to Firebase';
                
                // Clean up test document
                const testDocs = await testCollection.where('test', '==', true).get();
                testDocs.forEach(doc => doc.ref.delete());
                
            } catch (error) {
                statusDiv.className = 'status offline';
                statusDiv.textContent = 'Firebase connection failed: ' + error.message;
                console.error('Firebase connection error:', error);
            }
        }
        
        async function testCreateUser() {
            const resultsDiv = document.getElementById('test-results');
            
            try {
                const testUserData = {
                    username: 'firebase_test_' + Date.now(),
                    email: 'firebasetest' + Date.now() + '@example.com',
                    first_name: 'Firebase',
                    last_name: 'Test',
                    password_hash: 'dummy_hash_for_testing',
                    role: 'user',
                    is_active: true,
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };
                
                testUserId = await FirebaseHelper.create('users', testUserData);
                
                resultsDiv.innerHTML += `
                    <div class="test-result">
                        ‚úÖ Test user created successfully!<br>
                        User ID: ${testUserId}<br>
                        Username: ${testUserData.username}<br>
                        Email: ${testUserData.email}
                    </div>
                `;
            } catch (error) {
                resultsDiv.innerHTML += `
                    <div class="test-error">
                        ‚ùå Failed to create test user: ${error.message}
                    </div>
                `;
                console.error('Error creating user:', error);
            }
        }
        
        async function testListUsers() {
            const resultsDiv = document.getElementById('test-results');
            
            try {
                const users = await FirebaseHelper.readAll('users', [], null, 5);
                
                let usersList = '<div class="test-result">üë• Users in database:<br>';
                users.forEach(user => {
                    usersList += `
                        <div style="margin: 10px 0; padding: 10px; background: #f0f0f0; border-radius: 3px;">
                            <strong>${user.username}</strong> (${user.email})<br>
                            Name: ${user.first_name} ${user.last_name}<br>
                            Role: ${user.role}<br>
                            Active: ${user.is_active ? 'Yes' : 'No'}<br>
                            ID: ${user.id}
                        </div>
                    `;
                });
                usersList += '</div>';
                
                resultsDiv.innerHTML += usersList;
                
            } catch (error) {
                resultsDiv.innerHTML += `
                    <div class="test-error">
                        ‚ùå Failed to list users: ${error.message}
                    </div>
                `;
                console.error('Error listing users:', error);
            }
        }
        
        async function testUpdateUser() {
            const resultsDiv = document.getElementById('test-results');
            
            if (!testUserId) {
                resultsDiv.innerHTML += `
                    <div class="test-error">
                        ‚ùå No test user to update. Create a test user first.
                    </div>
                `;
                return;
            }
            
            try {
                const updateData = {
                    first_name: 'Updated Firebase',
                    last_name: 'Test User',
                    updated_at: new Date().toISOString()
                };
                
                await FirebaseHelper.update('users', testUserId, updateData);
                
                resultsDiv.innerHTML += `
                    <div class="test-result">
                        ‚úÖ Test user updated successfully!<br>
                        User ID: ${testUserId}<br>
                        Updated name: ${updateData.first_name} ${updateData.last_name}
                    </div>
                `;
            } catch (error) {
                resultsDiv.innerHTML += `
                    <div class="test-error">
                        ‚ùå Failed to update test user: ${error.message}
                    </div>
                `;
                console.error('Error updating user:', error);
            }
        }
        
        async function testDeleteUser() {
            const resultsDiv = document.getElementById('test-results');
            
            if (!testUserId) {
                resultsDiv.innerHTML += `
                    <div class="test-error">
                        ‚ùå No test user to delete. Create a test user first.
                    </div>
                `;
                return;
            }
            
            try {
                await FirebaseHelper.delete('users', testUserId);
                
                resultsDiv.innerHTML += `
                    <div class="test-result">
                        ‚úÖ Test user deleted successfully!<br>
                        Deleted User ID: ${testUserId}
                    </div>
                `;
                
                testUserId = null; // Clear the test user ID
            } catch (error) {
                resultsDiv.innerHTML += `
                    <div class="test-error">
                        ‚ùå Failed to delete test user: ${error.message}
                    </div>
                `;
                console.error('Error deleting user:', error);
            }
        }
        
        function clearResults() {
            document.getElementById('test-results').innerHTML = '';
        }
    </script>
</body>
</html>